<html>
	<head>
		<title>IO</title>
	</head>
	<body>
		<div ms-controller="YueMa">
			
			<input type="text" ms-duplex="username" /><br />
			<button ms-click="ready()">Ready</button>
			<div ms-html='task'></div>
			<div>{{ countdown / 1000 }}</div>
			<textarea ms-duplex="code" ms-input="update(event)"></textarea>
			<button ms-click="submit()">Submit</button>
			<div>{{ score }}</div>
			<input type="text" ms-duplex="msg" /><br />
			<button ms-click="message()">Message</button>

		</div>
		<script type="text/javascript" src="https://cdn.Socket.io/socket.io-1.3.7.js"></script>
		<script type="text/javascript" src="https://cdn.rawgit.com/RubyLouvre/avalon/master/dist/avalon.js"></script>
		<script type="text/javascript">

		function input(event) {

			console.log(event);

		}

		var YueMa = avalon.define({
			$id: 'YueMa',
			username: '',
			task: '',
			deadline: 0,
			code: '',
			countdown: 0,
			score: 0,
			msg: '',
			ready: function() {
				window.Socket.emit('Ready', {
					username: YueMa.username
				});
			},
			update: function() {
				window.Socket.emit('Push', {
					code: YueMa.code
				});
			},
			submit: function() {
				window.Socket.emit('Submit', {});
			},
			message: function() {
				window.Socket.emit('Message', {
					message: YueMa.msg
				});
			},
		})

		var namespace = '/YueMa';
		window.Socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

		Socket.on('connect', function() {

			console.log('INFO_CONNECTED');

		});

		Socket.on('error', function() {

			console.log('ERROR_CONNECTING');

		});

		Socket.on('disconnect', function() {

			console.log('INFO_DISCONNECTED');

		});

		Socket.on('Start', function(data) {

			console.log('Start');
			console.log(data);
			YueMa.task = data.task;
			YueMa.deadline = data.deadline;
			YueMa.countdown = data.deadline;

			var countdown = function() {

				YueMa.countdown -= 100;

				if(YueMa.countdown >= 100) setTimeout(countdown, 100);
				else {
					YueMa.countdown = 0;
					YueMa.submit();
				}

			};

			countdown();

		});

		Socket.on('Acquire', function(data) {

			console.log('Acquire');
			console.log(data);

		});

		Socket.on('Push', function(data) {

			console.log('Push');
			console.log(data);

			YueMa.code = data.code;

		});

		Socket.on('Release', function(data) {

			console.log('Release');
			console.log(data);

		});

		Socket.on('Result', function(data) {

			console.log('Result');
			console.log(data);

			YueMa.score = data.score;

		});

		Socket.on('Message', function(data) {

			console.log('Message');
			console.log(data);

			alert(data.message);

		});

		</script>
	</body>
</html>